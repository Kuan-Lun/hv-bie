# Performance Guidelines

本文件為 HV-BIE（HTML 解析）之效能最佳化指導，對齊 SRS 的 NFR-P1（單頁解析平均 ≲ 50ms，指引值）。

## 衡量與工具

- 基準測試：以 Python `time.perf_counter()` 或 pytest-benchmark 量測 `parse_snapshot` 單次/多次平均
- 探查：`cProfile`/`scalene`/`pyinstrument` 尋找熱點（避免過度微觀）
- 記憶體：`tracemalloc` 觀察尖峰分配

## 關鍵效能指標

- 單頁解析耗時（ms）
- DOM 走訪次數與重複解析避免程度
- 字串處理與正規表達式使用次數

## 最佳化策略（解析場景）

### DOM 解析

- 只建立一次 BeautifulSoup 物件；避免重複解析
- 合理使用 `select`/`find_all`，減少深層複合選擇器
- 將共用節點快取於區域變數，避免多次查詢

### 字串與百分比解析

- 將常用正則事先編譯
- 對百分比條的數值抽共用 util 函式，避免重複邏輯

### 結果聚合

- 單趟收集需要的資訊；避免多階段重複掃描
- 僅在必要時建立中間物件

## 效能測試設計

- 以樣本 HTML（庫內提供）為基礎，多次迭代取平均
- 確保測試無 I/O、無網路請求、無 sleep
- 在不同大小與內容的樣本上測，發現退化點

## 回歸監控

- 建立簡單基準並在 PR 中比對主要路徑耗時
- 若耗時明顯上升，定位新增查詢或正則成本

## 注意事項

- 效能優化不得破壞資料正確性與 SRS 鍵名/型別契約
- 優先可讀性與清晰結構；僅對熱點做局部優化
